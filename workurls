#!/bin/bash
set -e  # Exit on error

# Display usage information
show_usage() {
  echo "Usage: $(basename "$0") [OPTIONS]"
  echo "Opens URLs listed in a bookmarks file using a tmux session."
  echo
  echo "Options:"
  echo "  -f, --file FILE    Use custom bookmarks file (default: ~/Documents/default_bookmarks.url)"
  echo "  -s, --session NAME Use custom tmux session name (default: workurls)"
  echo "  -h, --help         Show this help message and exit"
  echo
  echo "Format of bookmarks file: Each line should contain 'name|url'"
  exit 0
}

# Check for required commands
for cmd in tmux xdg-open; do
  if ! command -v "$cmd" &> /dev/null; then
    echo "Error: Required command '$cmd' not found. Please install it and try again."
    exit 1
  fi
done

# Define default session name
SESSION_NAME="workurls"

# Default bookmarks file
DEFAULT_BOOKMARKS_FILE="$HOME/Documents/bookmarks/default_bookmarks.url"
BOOKMARKS_FILE="$DEFAULT_BOOKMARKS_FILE"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--file)
      BOOKMARKS_FILE="$2"
      shift 2
      ;;
    -s|--session)
      SESSION_NAME="$2"
      shift 2
      ;;
    -h|--help)
      show_usage
      ;;
    *)
      echo "Unknown option: $1"
      show_usage
      ;;
  esac
done

# Check if the bookmarks file exists
if [ ! -f "$BOOKMARKS_FILE" ]; then
  echo "Error: Bookmarks file not found: $BOOKMARKS_FILE"
  exit 1
fi

# Kill existing session if it's running
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "Killing existing session: $SESSION_NAME"
  if ! tmux kill-session -t "$SESSION_NAME"; then
    echo "Warning: Failed to kill existing session. Continuing anyway..."
  fi
fi

run_url_opener() {
  local bookmarks_file="${BOOKMARKS_FILE:-$DEFAULT_BOOKMARKS_FILE}"
  echo "Processing URLs from: $bookmarks_file"
  # Process URLs
  cut -d'|' -f2 "$bookmarks_file" | while read url; do
    # Skip empty lines
    if [ -n "$url" ]; then
      echo "Opening: $url"
      if ! xdg-open "$url"; then
        echo "Error opening URL: $url"
      fi
      sleep 1  # gives browser time to open each one
    fi
  done
}

# Create a new tmux session
echo "Creating new tmux session: $SESSION_NAME"
if ! tmux new-session -d -s "$SESSION_NAME"; then
  echo "Error: Failed to create new tmux session"
  exit 1
fi

# Run the URL opener function within the tmux session
echo "Running URL opener in tmux session"
# Pass the bookmarks file path to the function in the tmux session
if ! tmux send-keys -t "$SESSION_NAME" "BOOKMARKS_FILE=\"$BOOKMARKS_FILE\"; $(declare -f run_url_opener); run_url_opener" C-m; then
  echo "Error: Failed to send commands to tmux session"
  exit 1
fi

# Optionally attach to the session
# Uncomment the line below if you want to attach to the session automatically
# tmux attach-session -t "$SESSION_NAME"

echo "URLs are being opened in tmux session: $SESSION_NAME"
echo "Use 'tmux attach-session -t $SESSION_NAME' to view the session"

exit 0
